{% extends 'base.html' %}
{% load static %}
{% block title %}My Coupons{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/coupon.css' %}">
<script src="{% static 'js/coupon.js' %}" defer></script>

<div class="container mt-5">
  <h3 class="mb-4 text-center fw-bold">üéüÔ∏è My Coupons</h3>

  <!-- üîî Colorful Message Area -->
  <div id="coupon-message" class="mb-4"></div>

  {% if coupons %}
    <div class="row g-4">
      {% for coupon in coupons %}
      <div class="col-md-4 col-sm-6">
        <div class="card coupon-card h-100 shadow-sm">
          <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="text-primary fw-bold mb-0">
                <i class="bi bi-ticket-perforated"></i> {{ coupon.code }}
              </h5>
              <span class="badge bg-success fs-6">
                {{ coupon.discount_percent }}% OFF
              </span>
            </div>

            <p class="mb-2 text-muted">
              <strong>Valid From:</strong><br>
              {{ coupon.valid_from|date:"Y-m-d H:i" }}
            </p>

            <p class="mb-2 text-muted">
              <strong>Valid To:</strong><br>
              {{ coupon.valid_to|date:"Y-m-d H:i" }}
            </p>

            <p class="mb-3">
              <strong>Usage:</strong>
              <span class="text-primary fw-semibold used-count"
                    data-coupon-id="{{ coupon.id }}">
                {{ coupon.used_count }}
              </span>
              / {{ coupon.usage_limit }}
            </p>

            <div class="d-flex gap-2">

              <!-- üü¢ Apply Coupon (AJAX Enabled) -->
              <form method="post"
                    action="{% url 'coupon_apply' coupon.id %}"
                    class="coupon-form w-100"
                    data-coupon-id="{{ coupon.id }}">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-primary btn-sm w-100 apply-btn"
                        {% if coupon.used_count >= coupon.usage_limit %}
                          disabled
                        {% endif %}>
                  {% if coupon.used_count >= coupon.usage_limit %}
                    Used / Expired
                  {% else %}
                    Apply Coupon
                  {% endif %}
                </button>
              </form>

              <a href="{% url 'cart_detail' %}"
                 class="btn btn-outline-secondary btn-sm w-100">
                Return
              </a>

            </div>
          </div>

          <div class="card-footer text-center">
            {% if coupon.used_count >= coupon.usage_limit %}
              <span class="text-danger fw-semibold">
                <i class="fa fa-times-circle me-1"></i>
                Expired or Fully Used
              </span>
            {% else %}
              <span class="text-success fw-semibold">
                <i class="fa fa-check-circle me-1"></i>
                Available
              </span>
            {% endif %}
          </div>

        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <img src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png"
           alt="No Coupons"
           width="110"
           class="mb-3">
      <p class="fs-5 text-muted">
        You don‚Äôt have any coupons assigned yet.
      </p>
    </div>
  {% endif %}
</div>

{% endblock %}
